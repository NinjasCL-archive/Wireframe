<?php

namespace Wireframe;

/**
 * Container for View Placeholders
 * 
 * @version 0.1.0
 * @author Teppo Koivula <teppo@wireframe-framework.com>
 * @license Mozilla Public License v2.0 http://mozilla.org/MPL/2.0/
 */
class ViewPlaceholders {
    
    /**
     * The Page instance associated with current placeholders object
     *
     * @var ProcessWire\Page
     */
    private $page;
    
    /**
     * Directory containing view files
     *
     * @var string
     */
    private $views;

    /**
     * Template name
     *
     * Optional. If provided, this overrides the template of the Page instance.
     *
     * @var string|null
     */
    private $template;
    
    /**
     * View file extension
     *
     * @var string
     */
    private $ext;

    /**
     * Container for data
     *
     * @var array
     */
    private $data = [];
    
    /**
     * Constructor method
     * 
     * @param ProcessWire\Page $page
     * @param string $views_dir Views directory
     * @param string $ext Extension for view files
     * @param string|null $template Template name (optional)
     *
     * @throws Exception if views directory is missing or unreadable
     * @throws Exception if invalid format is used for view file extension
     * @throws Exception if invalid format is used for template name
     * @throws Exception if template name doesn't match expected format
     */
    public function __construct(\ProcessWire\Page $page, string $views, string $ext, ?string $template = null) {

        // Set page
        $this->page = $page;

        // Set, validate, and format views directory
        if (!is_dir($views)) {
            throw new \Exception(sprintf(
                'Missing or unreadable views directory: "%"',
                $views
            ));
        }
        if (strrpos($views, '/') !== 0) {
            $views .= "/";
        }
        $this->views = $views;

        // Set, validate, and format view file extension
        $this->ext = $ext;
        if (basename($this->ext) !== $this->ext) {
            throw new \Exception(sprintf(
                'View file extension does not match expected format: "%s".',
                $this->ext
            ));
        }
        if (strpos($this->ext, '.') !== 0) {
            $this->ext = '.' . $this->ext;
        }

        // Set and validate template
        $this->template = $template ?: $page->template;
        if ($this->template !== null && basename($this->template) != $this->template) {
            throw new \Exception(sprintf(
                'Template name does not match expected format: "%s".',
                $this->template
            ));
        }

    }
    
    /**
     * Generic getter method
     *
     * Return content from a named view placeholder, or markup generated by
     * rendering the page using a view matching the placeholder name.
     * 
     * @param string $key Name of a view placeholder or view
     * @return mixed Content stored in a view placeholder, or rendered output of a view
     */
    public function __get(string $key) {
        $return = $this->data[$key] ?? null;
        if (is_null($return) && basename($key) === $key) {
            if (is_file($this->views . $this->template . '/' . $key . $this->ext)) {
                $page_layout = $this->page->layout();
                $page_view = $this->page->view();
                $this->page->_wireframe_context = 'placeholder';
                $return = $this->page->layout('')->view($key)->render();
                unset($this->page->_wireframe_context);
                if ($page_layout !== '') {
                    $this->page->layout($page_layout);
                }
                if ($page_view !== $key) {
                    $this->page->view($page_view);
                }
            }
        }
        return $return;
    }

    /**
     * Store values to the protected $data array
     * 
     * @param string $key Name of a view placeholder
     * @param mixed $value Value to store in a view placeholder
     * @return ViewPlaceholders Current instance
     */
    public function __set(string $key, $value): ViewPlaceholders {
        $this->data[$key] = $value;
        return $this;
    }
    
}
